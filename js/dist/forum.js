/*! For license information please see forum.js.LICENSE.txt */
(()=>{var t={912:function(t){t.exports=function(){"use strict";var t=6e4,n=36e5,e="millisecond",r="second",s="minute",i="hour",o="day",a="week",u="month",c="quarter",l="year",f="date",d="Invalid Date",p=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,h=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,m={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(t){var n=["th","st","nd","rd"],e=t%100;return"["+t+(n[(e-20)%10]||n[e]||n[0])+"]"}},y=function(t,n,e){var r=String(t);return!r||r.length>=n?t:""+Array(n+1-r.length).join(e)+t},v={s:y,z:function(t){var n=-t.utcOffset(),e=Math.abs(n),r=Math.floor(e/60),s=e%60;return(n<=0?"+":"-")+y(r,2,"0")+":"+y(s,2,"0")},m:function t(n,e){if(n.date()<e.date())return-t(e,n);var r=12*(e.year()-n.year())+(e.month()-n.month()),s=n.clone().add(r,u),i=e-s<0,o=n.clone().add(r+(i?-1:1),u);return+(-(r+(e-s)/(i?s-o:o-s))||0)},a:function(t){return t<0?Math.ceil(t)||0:Math.floor(t)},p:function(t){return{M:u,y:l,w:a,d:o,D:f,h:i,m:s,s:r,ms:e,Q:c}[t]||String(t||"").toLowerCase().replace(/s$/,"")},u:function(t){return void 0===t}},g="en",b={};b[g]=m;var w="$isDayjsObject",x=function(t){return t instanceof k||!(!t||!t[w])},S=function t(n,e,r){var s;if(!n)return g;if("string"==typeof n){var i=n.toLowerCase();b[i]&&(s=i),e&&(b[i]=e,s=i);var o=n.split("-");if(!s&&o.length>1)return t(o[0])}else{var a=n.name;b[a]=n,s=a}return!r&&s&&(g=s),s||!r&&g},$=function(t,n){if(x(t))return t.clone();var e="object"==typeof n?n:{};return e.date=t,e.args=arguments,new k(e)},N=v;N.l=S,N.i=x,N.w=function(t,n){return $(t,{locale:n.$L,utc:n.$u,x:n.$x,$offset:n.$offset})};var k=function(){function m(t){this.$L=S(t.locale,null,!0),this.parse(t),this.$x=this.$x||t.x||{},this[w]=!0}var y=m.prototype;return y.parse=function(t){this.$d=function(t){var n=t.date,e=t.utc;if(null===n)return new Date(NaN);if(N.u(n))return new Date;if(n instanceof Date)return new Date(n);if("string"==typeof n&&!/Z$/i.test(n)){var r=n.match(p);if(r){var s=r[2]-1||0,i=(r[7]||"0").substring(0,3);return e?new Date(Date.UTC(r[1],s,r[3]||1,r[4]||0,r[5]||0,r[6]||0,i)):new Date(r[1],s,r[3]||1,r[4]||0,r[5]||0,r[6]||0,i)}}return new Date(n)}(t),this.init()},y.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},y.$utils=function(){return N},y.isValid=function(){return!(this.$d.toString()===d)},y.isSame=function(t,n){var e=$(t);return this.startOf(n)<=e&&e<=this.endOf(n)},y.isAfter=function(t,n){return $(t)<this.startOf(n)},y.isBefore=function(t,n){return this.endOf(n)<$(t)},y.$g=function(t,n,e){return N.u(t)?this[n]:this.set(e,t)},y.unix=function(){return Math.floor(this.valueOf()/1e3)},y.valueOf=function(){return this.$d.getTime()},y.startOf=function(t,n){var e=this,c=!!N.u(n)||n,d=N.p(t),p=function(t,n){var r=N.w(e.$u?Date.UTC(e.$y,n,t):new Date(e.$y,n,t),e);return c?r:r.endOf(o)},h=function(t,n){return N.w(e.toDate()[t].apply(e.toDate("s"),(c?[0,0,0,0]:[23,59,59,999]).slice(n)),e)},m=this.$W,y=this.$M,v=this.$D,g="set"+(this.$u?"UTC":"");switch(d){case l:return c?p(1,0):p(31,11);case u:return c?p(1,y):p(0,y+1);case a:var b=this.$locale().weekStart||0,w=(m<b?m+7:m)-b;return p(c?v-w:v+(6-w),y);case o:case f:return h(g+"Hours",0);case i:return h(g+"Minutes",1);case s:return h(g+"Seconds",2);case r:return h(g+"Milliseconds",3);default:return this.clone()}},y.endOf=function(t){return this.startOf(t,!1)},y.$set=function(t,n){var a,c=N.p(t),d="set"+(this.$u?"UTC":""),p=(a={},a[o]=d+"Date",a[f]=d+"Date",a[u]=d+"Month",a[l]=d+"FullYear",a[i]=d+"Hours",a[s]=d+"Minutes",a[r]=d+"Seconds",a[e]=d+"Milliseconds",a)[c],h=c===o?this.$D+(n-this.$W):n;if(c===u||c===l){var m=this.clone().set(f,1);m.$d[p](h),m.init(),this.$d=m.set(f,Math.min(this.$D,m.daysInMonth())).$d}else p&&this.$d[p](h);return this.init(),this},y.set=function(t,n){return this.clone().$set(t,n)},y.get=function(t){return this[N.p(t)]()},y.add=function(e,c){var f,d=this;e=Number(e);var p=N.p(c),h=function(t){var n=$(d);return N.w(n.date(n.date()+Math.round(t*e)),d)};if(p===u)return this.set(u,this.$M+e);if(p===l)return this.set(l,this.$y+e);if(p===o)return h(1);if(p===a)return h(7);var m=(f={},f[s]=t,f[i]=n,f[r]=1e3,f)[p]||1,y=this.$d.getTime()+e*m;return N.w(y,this)},y.subtract=function(t,n){return this.add(-1*t,n)},y.format=function(t){var n=this,e=this.$locale();if(!this.isValid())return e.invalidDate||d;var r=t||"YYYY-MM-DDTHH:mm:ssZ",s=N.z(this),i=this.$H,o=this.$m,a=this.$M,u=e.weekdays,c=e.months,l=e.meridiem,f=function(t,e,s,i){return t&&(t[e]||t(n,r))||s[e].slice(0,i)},p=function(t){return N.s(i%12||12,t,"0")},m=l||function(t,n,e){var r=t<12?"AM":"PM";return e?r.toLowerCase():r};return r.replace(h,(function(t,r){return r||function(t){switch(t){case"YY":return String(n.$y).slice(-2);case"YYYY":return N.s(n.$y,4,"0");case"M":return a+1;case"MM":return N.s(a+1,2,"0");case"MMM":return f(e.monthsShort,a,c,3);case"MMMM":return f(c,a);case"D":return n.$D;case"DD":return N.s(n.$D,2,"0");case"d":return String(n.$W);case"dd":return f(e.weekdaysMin,n.$W,u,2);case"ddd":return f(e.weekdaysShort,n.$W,u,3);case"dddd":return u[n.$W];case"H":return String(i);case"HH":return N.s(i,2,"0");case"h":return p(1);case"hh":return p(2);case"a":return m(i,o,!0);case"A":return m(i,o,!1);case"m":return String(o);case"mm":return N.s(o,2,"0");case"s":return String(n.$s);case"ss":return N.s(n.$s,2,"0");case"SSS":return N.s(n.$ms,3,"0");case"Z":return s}return null}(t)||s.replace(":","")}))},y.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},y.diff=function(e,f,d){var p,h=this,m=N.p(f),y=$(e),v=(y.utcOffset()-this.utcOffset())*t,g=this-y,b=function(){return N.m(h,y)};switch(m){case l:p=b()/12;break;case u:p=b();break;case c:p=b()/3;break;case a:p=(g-v)/6048e5;break;case o:p=(g-v)/864e5;break;case i:p=g/n;break;case s:p=g/t;break;case r:p=g/1e3;break;default:p=g}return d?p:N.a(p)},y.daysInMonth=function(){return this.endOf(u).$D},y.$locale=function(){return b[this.$L]},y.locale=function(t,n){if(!t)return this.$L;var e=this.clone(),r=S(t,n,!0);return r&&(e.$L=r),e},y.clone=function(){return N.w(this.$d,this)},y.toDate=function(){return new Date(this.valueOf())},y.toJSON=function(){return this.isValid()?this.toISOString():null},y.toISOString=function(){return this.$d.toISOString()},y.toString=function(){return this.$d.toUTCString()},m}(),C=k.prototype;return $.prototype=C,[["$ms",e],["$s",r],["$m",s],["$H",i],["$W",o],["$M",u],["$y",l],["$D",f]].forEach((function(t){C[t[1]]=function(n){return this.$g(n,t[0],t[1])}})),$.extend=function(t,n){return t.$i||(t(n,k,$),t.$i=!0),$},$.locale=S,$.isDayjs=x,$.unix=function(t){return $(1e3*t)},$.en=b[g],$.Ls=b,$.p={},$}()},24:(t,n,e)=>{var r=e(735).default;function s(){"use strict";t.exports=s=function(){return e},t.exports.__esModule=!0,t.exports.default=t.exports;var n,e={},i=Object.prototype,o=i.hasOwnProperty,a=Object.defineProperty||function(t,n,e){t[n]=e.value},u="function"==typeof Symbol?Symbol:{},c=u.iterator||"@@iterator",l=u.asyncIterator||"@@asyncIterator",f=u.toStringTag||"@@toStringTag";function d(t,n,e){return Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}),t[n]}try{d({},"")}catch(n){d=function(t,n,e){return t[n]=e}}function p(t,n,e,r){var s=n&&n.prototype instanceof w?n:w,i=Object.create(s.prototype),o=new M(r||[]);return a(i,"_invoke",{value:D(t,e,o)}),i}function h(t,n,e){try{return{type:"normal",arg:t.call(n,e)}}catch(t){return{type:"throw",arg:t}}}e.wrap=p;var m="suspendedStart",y="suspendedYield",v="executing",g="completed",b={};function w(){}function x(){}function S(){}var $={};d($,c,(function(){return this}));var N=Object.getPrototypeOf,k=N&&N(N(E([])));k&&k!==i&&o.call(k,c)&&($=k);var C=S.prototype=w.prototype=Object.create($);function I(t){["next","throw","return"].forEach((function(n){d(t,n,(function(t){return this._invoke(n,t)}))}))}function _(t,n){function e(s,i,a,u){var c=h(t[s],t,i);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==r(f)&&o.call(f,"__await")?n.resolve(f.__await).then((function(t){e("next",t,a,u)}),(function(t){e("throw",t,a,u)})):n.resolve(f).then((function(t){l.value=t,a(l)}),(function(t){return e("throw",t,a,u)}))}u(c.arg)}var s;a(this,"_invoke",{value:function(t,r){function i(){return new n((function(n,s){e(t,r,n,s)}))}return s=s?s.then(i,i):i()}})}function D(t,e,r){var s=m;return function(i,o){if(s===v)throw Error("Generator is already running");if(s===g){if("throw"===i)throw o;return{value:n,done:!0}}for(r.method=i,r.arg=o;;){var a=r.delegate;if(a){var u=T(a,r);if(u){if(u===b)continue;return u}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(s===m)throw s=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);s=v;var c=h(t,e,r);if("normal"===c.type){if(s=r.done?g:y,c.arg===b)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(s=g,r.method="throw",r.arg=c.arg)}}}function T(t,e){var r=e.method,s=t.iterator[r];if(s===n)return e.delegate=null,"throw"===r&&t.iterator.return&&(e.method="return",e.arg=n,T(t,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),b;var i=h(s,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,b;var o=i.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=n),e.delegate=null,b):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,b)}function L(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function O(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function M(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function E(t){if(t||""===t){var e=t[c];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var s=-1,i=function e(){for(;++s<t.length;)if(o.call(t,s))return e.value=t[s],e.done=!1,e;return e.value=n,e.done=!0,e};return i.next=i}}throw new TypeError(r(t)+" is not iterable")}return x.prototype=S,a(C,"constructor",{value:S,configurable:!0}),a(S,"constructor",{value:x,configurable:!0}),x.displayName=d(S,f,"GeneratorFunction"),e.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===x||"GeneratorFunction"===(n.displayName||n.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,S):(t.__proto__=S,d(t,f,"GeneratorFunction")),t.prototype=Object.create(C),t},e.awrap=function(t){return{__await:t}},I(_.prototype),d(_.prototype,l,(function(){return this})),e.AsyncIterator=_,e.async=function(t,n,r,s,i){void 0===i&&(i=Promise);var o=new _(p(t,n,r,s),i);return e.isGeneratorFunction(n)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},I(C),d(C,f,"Generator"),d(C,c,(function(){return this})),d(C,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var n=Object(t),e=[];for(var r in n)e.push(r);return e.reverse(),function t(){for(;e.length;){var r=e.pop();if(r in n)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=E,M.prototype={constructor:M,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(O),!t)for(var e in this)"t"===e.charAt(0)&&o.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=n)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function r(r,s){return a.type="throw",a.arg=t,e.next=r,s&&(e.method="next",e.arg=n),!!s}for(var s=this.tryEntries.length-1;s>=0;--s){var i=this.tryEntries[s],a=i.completion;if("root"===i.tryLoc)return r("end");if(i.tryLoc<=this.prev){var u=o.call(i,"catchLoc"),c=o.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return r(i.catchLoc,!0);if(this.prev<i.finallyLoc)return r(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return r(i.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return r(i.finallyLoc)}}}},abrupt:function(t,n){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var s=r;break}}s&&("break"===t||"continue"===t)&&s.tryLoc<=n&&n<=s.finallyLoc&&(s=null);var i=s?s.completion:{};return i.type=t,i.arg=n,s?(this.method="next",this.next=s.finallyLoc,b):this.complete(i)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),b},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var e=this.tryEntries[n];if(e.finallyLoc===t)return this.complete(e.completion,e.afterLoc),O(e),b}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var e=this.tryEntries[n];if(e.tryLoc===t){var r=e.completion;if("throw"===r.type){var s=r.arg;O(e)}return s}}throw Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:E(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=n),b}},e}t.exports=s,t.exports.__esModule=!0,t.exports.default=t.exports},735:t=>{function n(e){return t.exports=n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t.exports.__esModule=!0,t.exports.default=t.exports,n(e)}t.exports=n,t.exports.__esModule=!0,t.exports.default=t.exports},183:(t,n,e)=>{var r=e(24)();t.exports=r;try{regeneratorRuntime=r}catch(t){"object"==typeof globalThis?globalThis.regeneratorRuntime=r:Function("r","regeneratorRuntime = r")(r)}}},n={};function e(r){var s=n[r];if(void 0!==s)return s.exports;var i=n[r]={exports:{}};return t[r].call(i.exports,i,i.exports,e),i.exports}e.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},e.d=(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},e.o=(t,n)=>Object.prototype.hasOwnProperty.call(t,n),e.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var r={};(()=>{"use strict";e.r(r),e.d(r,{WebsocketHelper:()=>S,extend:()=>c});const t=flarum.core.compat["common/extenders"];var n=e.n(t);function s(t,n){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},s(t,n)}function i(t,n){t.prototype=Object.create(n.prototype),t.prototype.constructor=t,s(t,n)}const o=flarum.core.compat["common/Model"];var a=e.n(o),u=function(t){function n(){for(var n,e=arguments.length,r=new Array(e),s=0;s<e;s++)r[s]=arguments[s];return(n=t.call.apply(t,[this].concat(r))||this).token=a().attribute("token"),n.url=a().attribute("url",(function(t){return t&&t.replace("0.0.0.0",location.hostname)})),n}return i(n,t),n}(a());const c=[(new(n().Store)).add("websocket-access-token",u)],l=flarum.core.compat["forum/app"];var f=e.n(l);function d(t,n,e,r,s,i,o){try{var a=t[i](o),u=a.value}catch(t){return void e(t)}a.done?n(u):Promise.resolve(u).then(r,s)}var p=e(183),h=e.n(p);const y=flarum.core.compat["common/utils/ItemList"];var v=e.n(y),g=function(){function t(t){if(this.nodes=void 0,this.data=void 0,t){if(t.endsWith("}")){var n=t.split("||");this.data=JSON.parse(n[1]),t=n[0]}this.nodes=t.split(".").map((function(t){var n={name:t};if(t.includes("[")){var e=t.split("["),r=e[0],s=e[1];n.id=s.substring(0,s.length-1),n.name=r}return n}))}else this.nodes=[]}var n=t.prototype;return n.toString=function(){return this.nodes.map((function(t){return t.id?t.name+"["+t.id+"]":t.name})).join(".")+(this.data?"||"+JSON.stringify(this.data):"")},n.add=function(t,n){return this.nodes.push({name:t,id:n}),this},n.get=function(t){return t?this.nodes.find((function(n){return n.name===t}))||null:this.nodes[this.nodes.length-1]||null},n.getId=function(t){var n=this.get(t);return n&&(n.id||null)},n.remove=function(t){var n=this.nodes.findIndex((function(n){return n.name===t}));return n>=0&&this.nodes.splice(n,1),this},n.getData=function(){return this.data},n.setData=function(t){return this.data=t,this},t}(),b=e(912),w=e.n(b),x=[100,2e3,5e3,1e4,6e4,12e4],S=function(){function t(){this.app=void 0,this.ws=void 0,this.statusChangeCb=void 0,this.lastConnected=0,this.firstSubscribe=!0,this.context={},this.lastSubscribes=[],this.pingInterval=void 0,this.nextRetry=0,this.inRetryStatus=!1,this.sendInConnecting=[]}t.getInstance=function(){return t.instance||(t.instance=new t),t.instance};var n=t.prototype;return n.init=function(t){this.app=t,this.lastConnected=w()().unix()-5},n.stop=function(){try{var t;null==(t=this.ws)||t.close(),this.ws=void 0}catch(t){}},n.start=function(){var t,n=(t=h().mark((function t(){var n,e,r=this;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.app){t.next=25;break}if(this.app.forum.attribute("xyppWsnEnable")){t.next=3;break}return t.abrupt("return");case 3:if(this.sendInConnecting=[],this.ws)try{this.ws.onclose=function(){},this.ws.close()}finally{this.ws=void 0}return this.statusChangeCb&&this.statusChangeCb("connecting"),n=null,t.prev=7,t.next=10,this.app.store.createRecord("websocket-access-token").save({});case 10:n=t.sent,t.next=16;break;case 13:t.prev=13,t.t0=t.catch(7),this.retry();case 16:if(n){t.next=19;break}return this.retry(),t.abrupt("return");case 19:e=new WebSocket(n.url()),this.ws=e,e.onclose=function(){r.retry(),r.pingInterval&&clearInterval(r.pingInterval)},e.onerror=function(){r.retry(),r.pingInterval&&clearInterval(r.pingInterval)},e.onopen=function(){r.firstSubscribe=!0,r.lastSubscribes=[],r.reSubscribe(),r.pingInterval=setInterval(r.ping.bind(r),3e4),r.sendInConnecting.forEach((function(t){return r.send(t)})),r.sendInConnecting=[],r.statusChangeCb&&r.statusChangeCb("online"),r.nextRetry=0,r.lastConnected=w()().unix()},e.onmessage=function(t){r.lastConnected=w()().unix();var n=JSON.parse(t.data);"sync"===n.type&&r.messageHandler(new g(n.path),n.data)};case 25:case"end":return t.stop()}}),t,this,[[7,13]])})),function(){var n=this,e=arguments;return new Promise((function(r,s){var i=t.apply(n,e);function o(t){d(i,r,s,o,a,"next",t)}function a(t){d(i,r,s,o,a,"throw",t)}o(void 0)}))});return function(){return n.apply(this,arguments)}}(),n.messageHandler=function(t,n){console.log("No handler found "+t.toString()+": "+JSON.stringify(n))},n.getSubscribes=function(t){return new(v())},n.setContext=function(t){var n=this;return Object.keys(t).forEach((function(e){null===t[e]&&n.context[e]?delete n.context[e]:n.context[e]=t[e]})),this},n.reSubscribe=function(t){var n=this.getSubscribes(Object.assign(t||{},this.context)).toArray().map((function(t){return t.toString()}));if(console.log("ReSubscribe: "+n.join(", ")),this.changed(n)){this.lastSubscribes=n;var e={type:"subscribe",path:n};return this.firstSubscribe&&(this.firstSubscribe=!1,e.restore=w()().unix()-this.lastConnected),this.send(e),this}},n.state=function(t){var n;null!=(n=this.app)&&n.session.user&&this.send({type:"state",path:t.toString()})},n.send=function(t){if(this.ws)if(this.ws.readyState===WebSocket.CONNECTING)this.sendInConnecting.push(t);else if(this.ws.readyState===WebSocket.OPEN)try{this.ws.send(JSON.stringify(t))}catch(t){console.log("Error Websocket Sending "+t)}},n.onStatusChange=function(t){this.statusChangeCb=t},n.retry=function(){var t=this;this.inRetryStatus||(this.inRetryStatus=!0,this.statusChangeCb&&this.statusChangeCb("offline"),setTimeout((function(){t.inRetryStatus=!1,t.start()}),x[this.nextRetry-1]),this.nextRetry<x.length&&(this.nextRetry+=1))},n.ping=function(){this.send({type:"ping"})},n.changed=function(t){if(t.sort((function(t,n){return t.localeCompare(n)})),t.length!==this.lastSubscribes.length)return!0;for(var n=0;n<t.length;n++)if(t[n]!==this.lastSubscribes[n])return!0;return!1},t}();S.instance=void 0;const N=flarum.core.compat["common/extend"];function k(t,n){(0,N.extend)(S.prototype,"getSubscribes",n)}function C(t,n){(0,N.override)(S.prototype,"messageHandler",(function(e,r,s){var i;if((null==(i=r.get())?void 0:i.name)==t)return n(r,s);e(r,s)}))}const I=flarum.core.compat["common/Component"];var _=e.n(I);function D(t,n,e){return t?n:e||""}const T=flarum.core.compat["common/components/Button"];var L=e.n(T),O=function(t){function n(){return t.apply(this,arguments)||this}return i(n,t),n.prototype.view=function(t){var n,e=((null==(n=f().session)||null==(n=n.user)?void 0:n.preferences())||{}).xyppWsnFloaterPosition||"center";return m("div",{className:D(this.attrs.notifications.length>0,"notification-floater","notification-floater hidden")+" "+e},this.attrs.notifications.map((function(t){var n=t.notification.data.attributes.contentType,e=f().notificationComponents[n];return m("div",{className:D(t.first,"notification-floater-item in","notification-floater-item")},D(!!e,m(e,{notification:t.notification}),m("div",null,n)))})),m("div",{className:"notification-floater-close-container"},m(L(),{className:"Button Button-primary",onclick:this.attrs.dismiss},m("i",{className:"fas fa-times"}),f().translator.trans("xypp-websocket-notification.forum.close_notification_floater"))))},n}(_());const M=flarum.core.compat["forum/components/SettingsPage"];var E=e.n(M);const P=flarum.core.compat["common/components/FieldSet"];var W=e.n(P);const j=flarum.core.compat["common/components/Select"];var A=e.n(j);const R=flarum.core.compat["common/components/Link"];var U=e.n(R);const F=flarum.core.compat["common/helpers/avatar"];var B=e.n(F);const H=flarum.core.compat["common/helpers/icon"];var Y=e.n(H);const G=flarum.core.compat["common/helpers/username"];var J=e.n(G);const z=flarum.core.compat["common/helpers/humanTime"];var Z=e.n(z),V=function(t){function n(){return t.apply(this,arguments)||this}return i(n,t),n.prototype.view=function(){var t=this.attrs.notification.data.attributes.flag,n=t.post();return m(U(),{href:f().route.post(n),className:"Notification Flag",onclick:function(t){f().flags.index=n,t.redraw=!1}},B()(n.user()),Y()("fas fa-flag",{className:"Notification-icon"}),m("span",{className:"Notification-content"},f().translator.trans("flarum-flags.forum.flagged_posts.item_text",{username:J()(n.user()),em:m("em",null),discussion:n.discussion().title()})),Z()(t.createdAt()),m("div",{className:"Notification-excerpt"},n.contentPlain()))},n}(_()),q=0;function Q(){document.hasFocus()||(q++,console.log("Update unread:"+q),f().setTitleCount(q))}const K=flarum.core.compat["forum/components/DiscussionPage"];var X=e.n(K);const tt=flarum.core.compat["forum/components/DiscussionList"];var nt=e.n(tt),et=function(t){function n(){for(var n,e=arguments.length,r=new Array(e),s=0;s<e;s++)r[s]=arguments[s];return(n=t.call.apply(t,[this].concat(r))||this).autoRefreshTimeout=null,n.autoRefresh=!1,n.countdown=30,n}i(n,t);var e=n.prototype;return e.oncreate=function(n){var e,r=this;t.prototype.oncreate.call(this,n),this.autoRefresh=(null==(e=f().session)||null==(e=e.user)||null==(e=e.preferences())?void 0:e.xyppWsnNewDiscussionAutoRefresh)||!1,this.autoRefresh&&(this.autoRefreshTimeout=setInterval((function(){r.updateCtd()}),1e3))},e.onbeforeremove=function(n){t.prototype.onbeforeremove.call(this,n),this.autoRefreshTimeout&&clearInterval(this.autoRefreshTimeout)},e.view=function(t){return m("div",{className:"ComingDiscussion"},m("div",{className:"ComingDiscussion-icon"},m("i",{className:"fas fa-star-of-life"}),m("div",{className:"ComingDiscussion-icon-text"},f().translator.trans("xypp-websocket-notification.forum.new_discussion.tip"))),m("div",{className:"ComingDiscussion-item-container"},this.attrs.list.map((function(t){return m("div",{class:"ComingDiscussion-item"},m("span",{className:"ComingDiscussion-count"},t.count),m(U(),{className:"ComingDiscussion-link",href:f().route("discussion.near",{id:t.id,near:t.post})},t.title))}))),m("div",{className:"ComingDiscussion-Reload"},m(L(),{class:"Button",onclick:this.callback.bind(this)},m("i",{className:"fas fa-sync"})),D(this.autoRefresh,m("div",{className:"autoReloadIndicator"},this.countdown))))},e.callback=function(){this.autoRefreshTimeout&&(clearInterval(this.autoRefreshTimeout),this.autoRefreshTimeout=null,this.autoRefresh=!1),this.attrs.cb()},e.updateCtd=function(){this.countdown>0&&(this.countdown--,0==this.countdown&&this.callback(),m.redraw())},n}(_());const rt=flarum.core.compat["common/components/Switch"];var st=e.n(rt);const it=flarum.core.compat["forum/components/ComposerBody"];var ot=e.n(it);const at=flarum.core.compat["forum/components/PostStream"];var ut=e.n(at),ct=function(t){function n(){return t.apply(this,arguments)||this}return i(n,t),n.prototype.view=function(t){var n=parseInt(f().forum.attribute("xyppWsnTypeTipCountLimit")||"4");return this.attrs.typingUsers.length?m("div",{className:"PostStream-item"},m("div",{className:"LineContainer"},m("div",{className:"users"},this.attrs.typingUsers.slice(0,n).map((function(t){return m(U(),{className:"typingUser",href:f().route.user(t)},B()(t),m("span",{className:"username"},J()(t)))}))),D(this.attrs.typingUsers.length>n,m("div",null,f().translator.trans("xypp-websocket-notification.forum.typing.and_more",{rest:this.attrs.typingUsers.length-n}))),m("div",null,f().translator.trans("xypp-websocket-notification.forum.typing.is_typing")))):m("div",null,f().translator.trans("xypp-websocket-notification.forum.typing.no_one"))},n}(_());function lt(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=Array(n);e<n;e++)r[e]=t[e];return r}const ft=flarum.core.compat["common/models/User"];var dt=e.n(ft);function pt(){!function(){var t=[];function n(){for(;t.length;)t.pop()}k(0,(function(t){var n,e;null!=(n=f().session)&&n.user&&t.add("notification",(new g).add("notification",f().session.user.id())),null!=(e=f().session)&&null!=(e=e.user)&&e.isAdmin()&&t.add("flag",(new g).add("flag"))})),C("notification",(function(n,e){var r,s,i={time:8,first:!1,notification:f().store.pushPayload(e)};t.unshift(i),Q(),f().session.user&&f().session.user.pushAttributes({unreadNotificationCount:(null!=(r=f().session.user.unreadNotificationCount())?r:0)+1,newNotificationCount:(null!=(s=f().session.user.newNotificationCount())?s:0)+1}),m.redraw(),setTimeout((function(){i.first=!0,m.redraw()}),100)})),C("flag",(function(n,e){var r,s=f().store.pushPayload(e),i={time:8,first:!1,notification:{data:{attributes:{contentType:"wrappedFlag",flag:s}}}};t.unshift(i),null!=(r=f().flags)&&r.cache&&Array.isArray(f().flags.cache)&&f().flags.cache.unshift(s),f().forum.data.attributes.flagCount++,m.redraw(),setTimeout((function(){i.first=!0,m.redraw()}),100)}));var e=$("<div></div>").addClass("notification-floater-container");e.appendTo(document.body),m.mount(e[0],{view:function(){return O.component({notifications:t,dismiss:n})}}),setInterval((function(){t.forEach((function(t){t.time--}));for(var n=!1,e=t.length-1;e>=0;e--)t[e].time<=0&&(t.splice(e,1),n=!0);n&&m.redraw()}),1e3);var r={left:f().translator.trans("xypp-websocket-notification.forum.notification_floater.left"),right:f().translator.trans("xypp-websocket-notification.forum.notification_floater.right"),center:f().translator.trans("xypp-websocket-notification.forum.notification_floater.center")};(0,N.extend)(E().prototype,"settingsItems",(function(t){var n,e=((null==(n=f().session)||null==(n=n.user)?void 0:n.preferences())||{}).xyppWsnFloaterPosition||"center";t.add("xypp-wsn-floater-position",m(W(),{label:f().translator.trans("xypp-websocket-notification.forum.notification_floater.title"),className:"Settings-floater"},m("p",null,f().translator.trans("xypp-websocket-notification.forum.notification_floater.desc")),m(A(),{options:r,value:e,onchange:function(t){f().session.user.savePreferences({xyppWsnFloaterPosition:t})}})))})),f().notificationComponents.wrappedFlag=V}(),function(){k(0,(function(t,n){n.discussion&&t.add("discussion",(new g).add("discussion",n.discussion).add("post"))})),C("post",(function(t,n){var e,r=(null!=(e=f().current.data)?e:{}).routeName;if("discussion"===r||"discussion.near"===r){var s=f().current.data.discussion,i=f().current.get("stream");if(s.id()==t.getId("discussion")&&i.viewingEnd()){var o=f().store.pushPayload(n);s.data.relationships.posts.data.find((function(t){return t.id==o.id()}))?m.redraw():(s.data.relationships.posts.data.push({type:"posts",id:o.id()}),i.loadNext(),Q())}}}));var t=0;(0,N.extend)(X().prototype,"show",(function(n,e){e&&(t++,S.getInstance().setContext({discussion:e.id()}).reSubscribe())})),(0,N.extend)(X().prototype,"onbeforeremove",(function(){this.discussion&&(--t<0&&(t=0),0==t&&S.getInstance().setContext({discussion:null}).reSubscribe())}))}(),function(){k(0,(function(t,n){if(n.discussionList)if(n.discussionListTag){var e=f().store.getBy("tags","slug",n.discussionListTag);e&&t.add("discussionList",(new g).add("tag",e.id()).add("discussion"))}else t.add("discussionList",(new g).add("discussion"))}));var t=[],n=[];C("discussion",(function(e,r){var s=f().store.pushPayload(r.discussion),i=n.findIndex((function(t){return t.id()==s.id()}));-1!=i&&n.splice(i,1),n.push(s),function(n,e,r){var s,i;if((null==(s=f().current)||null==(s=s.data)||null==(s=s.discussion)?void 0:s.id())!=n){for(var o=0,a=!1,u=0;u<t.length;u++)if(t[u].id==n){o=t[u].count,t.splice(u,1),a=!0;break}if(!a){var c,l=(null==(c=f().current)||null==(c=c.data)?void 0:c.routeName)||"";"discussion"!==l&&"discussion.near"!==l&&Q()}t.unshift({title:e,post:r,id:n,count:o+1});var d=((null==(i=f().session)||null==(i=i.user)?void 0:i.preferences())||{}).xyppWsnNewDiscussionListLen||5;t.length>d&&t.pop()}}(s.id(),s.title(),r.post),m.redraw()})),(0,N.extend)(nt().prototype,"view",(function(e){t.length&&e&&e.children&&Array.isArray(e.children)&&e.children.unshift(et.component({list:t,cb:function(){n.forEach(f().discussions.addDiscussion.bind(f().discussions)),t=[],n=[],m.redraw()}.bind(this)}))})),(0,N.extend)(nt().prototype,"oncreate",(function(){var t=this.attrs.state.params.tags;S.getInstance().setContext({discussionListTag:t,discussionList:!0}).reSubscribe()})),(0,N.extend)(nt().prototype,"onbeforeremove",(function(){S.getInstance().setContext({discussionList:null}).reSubscribe()})),(0,N.extend)(X().prototype,"show",(function(n,e){if(e)for(var r=t.length-1;r>=0;r--)if(t[r].id==e.id()){t.splice(r,1);break}}));var e=!1;(0,N.extend)(E().prototype,"settingsItems",(function(t){var n,r;t.add("xypp-wsn-newPostOption",m(W(),{label:f().translator.trans("xypp-websocket-notification.forum.new_discussion.title"),className:"Settings-newPost"},m("p",null,m(st(),{state:((null==(n=f().session)||null==(n=n.user)?void 0:n.preferences())||{}).xyppWsnNewDiscussionAutoRefresh||!1,onchange:function(t){var n;null==(n=f().session)||null==(n=n.user)||n.savePreferences({xyppWsnNewDiscussionAutoRefresh:t})}},f().translator.trans("xypp-websocket-notification.forum.new_discussion.auto_refresh"))),m("p",null,f().translator.trans("xypp-websocket-notification.forum.new_discussion.list_length")),m("div",null,m("input",{id:"input-xyppWsnNewDiscussionListLen",className:"FormControl",type:"number",value:((null==(r=f().session)||null==(r=r.user)?void 0:r.preferences())||{}).xyppWsnNewDiscussionListLen||5}),m(L(),{className:"Button Button--primary",onclick:function(t){var n;t.preventDefault(),e=!0,m.redraw(),null==(n=f().session)||null==(n=n.user)||n.savePreferences({xyppWsnNewDiscussionListLen:parseInt($("#input-xyppWsnNewDiscussionListLen").val())}).then((function(){e=!1,m.redraw()}))},disabled:e,loading:e},f().translator.trans("xypp-websocket-notification.forum.new_discussion.list_len_button")))))}))}(),k(0,(function(t,n){n.discussion&&t.add("like",(new g).add("discussion",n.discussion).add("post").add("like"))})),C("like",(function(t,n){var e=f().store.getById("posts",n.post);if(f().store.getById("users",n.user.data.id)||f().store.pushPayload(n.user),e){for(var r=e.data.relationships.likes,s=0;s<r.data.length;s++)if(r.data[s].id==n.user.data.id)return void(n.like||(r.data.splice(s,1),e.freshness=new Date,m.redraw()));n.like&&(r.data.push({type:"users",id:n.user.data.id}),e.freshness=new Date,m.redraw())}})),C("typing",(function(t,n){var e=f().store.getById("discussions",t.getId("discussion"));if(e){for(var r=e.typingUsers,s=0;s<r.length;s++)if(r[s].id()==t.getId("state")&&(r.splice(s,1),!n.state))return void m.redraw();if(!n.state)return void e.restTypingUsers--;r.unshift(f().store.pushPayload(n.user)),m.redraw()}})),k(0,(function(t,n){f().forum.attribute("xyppWsnTypeTip")&&n.discussion&&t.add("typing",(new g).add("state").add("session").add("discussion",n.discussion).add("typing"))})),(0,N.extend)(ot().prototype,"oninit",(function(t){var n,e,r;f().forum.attribute("xyppWsnTypeTip")&&(((null==(n=f().session)||null==(n=n.user)?void 0:n.preferences())||{}).xyppWsnNoTypeTip||(this.attrs.discussion&&S.getInstance().state((new g).add("state",null==(e=f().session)||null==(e=e.user)?void 0:e.id()).add("session").add("discussion",this.attrs.discussion.id()).add("typing")),this.attrs.post&&S.getInstance().state((new g).add("state",null==(r=f().session)||null==(r=r.user)?void 0:r.id()).add("session").add("discussion",this.attrs.post.discussion().id()).add("typing"))))})),(0,N.extend)(ot().prototype,"onbeforeremove",(function(t){var n,e,r;f().forum.attribute("xyppWsnTypeTip")&&(((null==(n=f().session)||null==(n=n.user)?void 0:n.preferences())||{}).xyppWsnNoTypeTip||(this.attrs.discussion&&S.getInstance().state((new g).add("state",null==(e=f().session)||null==(e=e.user)?void 0:e.id()).add("session").add("release").add("discussion",this.attrs.discussion.id()).add("typing")),this.attrs.post&&S.getInstance().state((new g).add("state",null==(r=f().session)||null==(r=r.user)?void 0:r.id()).add("session").add("release").add("discussion",this.attrs.post.discussion().id()).add("typing"))))})),(0,N.extend)(X().prototype,"show",(function(t,n){var e=n.attribute("typeTip");n.typingUsers=[];for(var r,s=function(t,n){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,n){if(t){if("string"==typeof t)return lt(t,n);var e={}.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?lt(t,n):void 0}}(t))||n&&t&&"number"==typeof t.length){e&&(t=e);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(e.user);!(r=s()).done;){var i=r.value,o=f().store.getById("users",i.data.id);o||(o=f().store.pushPayload(i)),n.typingUsers.push(o)}})),(0,N.extend)(ut().prototype,"endItems",(function(t){this.discussion.typingUsers.length&&t.add("typings",ct.component({typingUsers:this.discussion.typingUsers,key:"typingTip"}))})),(0,N.extend)(E().prototype,"settingsItems",(function(t){var n;t.add("xypp-wsn-typing-option",m(W(),{label:f().translator.trans("xypp-websocket-notification.forum.typing.title"),className:"Settings-typing"},m("p",null,m(st(),{state:((null==(n=f().session)||null==(n=n.user)?void 0:n.preferences())||{}).xyppWsnNoTypeTip||!1,onchange:function(t){var n;null==(n=f().session)||null==(n=n.user)||n.savePreferences({xyppWsnNoTypeTip:t})}},f().translator.trans("xypp-websocket-notification.forum.typing.no_type_tip")))))})),k(0,(function(t,n){n.discussion&&t.add("reaction",(new g).add("discussion",n.discussion).add("post").add("reaction"))})),C("reaction",(function(t,n){if(t.getId("post")){var e=f().store.getById("posts",t.getId("post"));e&&(e.pushAttributes({reactionCounts:n.counts}),e.freshness=new Date,m.redraw())}})),k(0,(function(t,n){t.add("online",(new g).add("state").add("online"))})),C("online",(function(t,n){var e=t.getId("state");if(e){var r=f().store.getById("users",e);r&&(r.pushAttributes({onlineState:n.state}),m.redraw())}})),(0,N.override)(dt().prototype,"isOnline",(function(t){var n=this.attribute("onlineState");return!1===n||!0===n?n:t()})),k(0,(function(t,n){if(n.discussion&&flarum.extensions["fof-polls"]){var e=f().store.getById("discussions",n.discussion);e.hasPoll()&&e.posts().forEach((function(n){var e=n.polls();e&&e.length&&e.forEach((function(n){t.add("poll-"+n.id(),(new g).add("poll",n.id()))}))}))}})),C("poll",(function(t,n){var e=0;Object.keys(n).forEach((function(t){var r=f().store.getById("poll_options",t);r&&(r.pushAttributes({voteCount:n[t]}),e+=n[t])}));var r=f().store.getById("polls",t.getId());null==r||r.pushAttributes({voteCount:e}),m.redraw()}))}var ht=function(t){function n(){for(var n,e=arguments.length,r=new Array(e),s=0;s<e;s++)r[s]=arguments[s];return(n=t.call.apply(t,[this].concat(r))||this).currentStatus="offline",n}i(n,t);var e=n.prototype;return e.oninit=function(n){t.prototype.oninit.call(this,n),S.getInstance().onStatusChange(this.status.bind(this))},e.view=function(t){return this.getContent()},e.getContent=function(){switch(this.currentStatus){case"online":return m("span",{className:"connectionIndicator-icon online"},m("i",{className:"far fa-circle"}),f().translator.trans("xypp-websocket-notification.forum.connection.connected"));case"offline":return m("span",{className:"connectionIndicator-icon offline"},m("i",{className:"fas fa-times"}),f().translator.trans("xypp-websocket-notification.forum.connection.disconnected"));case"connecting":return m("span",{className:"connectionIndicator-icon connecting"},m("i",{className:"fas fa-wifi"}),f().translator.trans("xypp-websocket-notification.forum.connection.connecting"));case"partial":return m("span",{className:"connectionIndicator-icon partial"},m("i",{className:"fas fa-circle"}),f().translator.trans("xypp-websocket-notification.forum.connection.partial"))}},e.status=function(t){this.currentStatus=t,m.redraw()},n}(_());const mt=flarum.core.compat["forum/components/HeaderSecondary"];var yt=e.n(mt);f().initializers.add("xypp/flarum-websocket-notification",(function(){S.getInstance().init(f()),pt(),setTimeout((function(){S.getInstance().start()}),0),(0,N.extend)(yt().prototype,"items",(function(t){f().forum.attribute("xyppWsnEnable")&&t.add("wsn",ht.component(),1e3)})),window.addEventListener("focus",(function(){q=0,f().setTitleCount(0)}))}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map